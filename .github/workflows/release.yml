name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write  # required for OIDC trusted publishing

jobs:
  # ── Linux wheels (manylinux) ───────────────────────────────────────────────
  linux:
    name: Build Linux (${{ matrix.target }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        target: [x86_64, aarch64]
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: ${{ matrix.target }}
          args: --release --out dist
          manylinux: auto
          before-script-linux: |
            # cmake + perl-IPC-Cmd are required by openssl-sys (vendored build)
            if command -v yum &>/dev/null; then
              yum install -y cmake perl-IPC-Cmd perl-Time-Piece
            fi

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-${{ matrix.target }}
          path: dist/*.whl

  # ── macOS x86_64 ──────────────────────────────────────────────────────────
  macos-x86_64:
    name: Build macOS x86_64
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-x86_64
          path: dist/*.whl

  # ── macOS arm64 ───────────────────────────────────────────────────────────
  macos-arm64:
    name: Build macOS arm64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: aarch64
          args: --release --out dist

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-macos-arm64
          path: dist/*.whl

  # ── Windows x86_64 ────────────────────────────────────────────────────────
  windows:
    name: Build Windows x86_64
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install cmake (required by openssl-sys)
        run: choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System' -y

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          args: --release --out dist

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-x86_64
          path: dist/*.whl

  # ── Source distribution ───────────────────────────────────────────────────
  sdist:
    name: Build sdist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist

      - uses: actions/upload-artifact@v4
        with:
          name: wheels-sdist
          path: dist/*.tar.gz

  # ── Publish ───────────────────────────────────────────────────────────────
  publish:
    name: Publish to PyPI + GitHub Release
    runs-on: ubuntu-latest
    needs: [linux, macos-x86_64, macos-arm64, windows, sdist]
    environment: pypi  # configure trusted publishing in this environment on PyPI
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # git-cliff needs full history to build the changelog
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate changelog for this release (release body)
        uses: orhun/git-cliff-action@v3
        id: cliff_body
        with:
          config: cliff.toml
          args: --current --strip all
        env:
          OUTPUT: body.md

      - name: Regenerate full CHANGELOG.md
        uses: orhun/git-cliff-action@v3
        with:
          config: cliff.toml
          args: --output CHANGELOG.md
        env:
          OUTPUT: CHANGELOG.md

      - name: Commit updated CHANGELOG.md
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md
          git diff --staged --quiet \
            || git commit -m "chore: update CHANGELOG for ${{ github.ref_name }}"
          git push origin HEAD:master

      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Publish to PyPI (OIDC trusted publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: body.md
