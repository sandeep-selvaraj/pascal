# pascal

[![PyPI version](https://img.shields.io/pypi/v/pascal-cli.svg)](https://pypi.org/project/pascal-cli/)
[![CI](https://github.com/sandeep-selvaraj/pascal/actions/workflows/ci.yml/badge.svg)](https://github.com/sandeep-selvaraj/pascal/actions/workflows/ci.yml)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)

**Fast Python monorepo manager powered by Rust and UV.**

Pascal is a CLI tool that makes managing Python monorepos straightforward. It handles workspace scaffolding, dependency wiring, cross-package testing, and UV workspace sync — so you can focus on code, not configuration.

**Why pascal?**
- UV-native: all package operations delegate to `uv`, the fastest Python package manager
- Monorepo-aware: understands the difference between reusable packages and deployable apps
- Zero config for simple cases: auto-discovers packages and apps from your directory layout
- Single binary: no Python runtime needed, no virtualenv, no PATH fiddling

---

## Installation

```bash
# pip
pip install pascal-cli

# uv (recommended)
uv tool install pascal-cli

# pipx
pipx install pascal-cli

# cargo (build from source)
cargo install --git https://github.com/sandeep-selvaraj/pascal
```

After installation, `pascal --version` should print the version.

---

## Quickstart

```
# 1. Create a new workspace
$ pascal init my-workspace
  Created my-workspace/pascal.toml
  Created my-workspace/pyproject.toml  (UV workspace root)
  Created my-workspace/uv.lock

$ cd my-workspace

# 2. Add a reusable library package
$ pascal create package cart
  Created packages/cart/pyproject.toml
  Created packages/cart/src/cart/__init__.py
  Created packages/cart/tests/test_cart.py

# 3. Add a deployable app
$ pascal create app api_service
  Created apps/api_service/pyproject.toml
  Created apps/api_service/src/api_service/__init__.py
  Created apps/api_service/src/api_service/main.py
  Created apps/api_service/tests/test_api_service.py

# 4. Wire the package into the app
$ pascal add cart --to api_service
  Updated apps/api_service/pyproject.toml
  Ran: uv sync

# 5. Check everything looks good
$ pascal info
  Workspace: my-workspace  (python 3.12)
  ├── packages
  │   └── cart  0.1.0
  └── apps
      └── api_service  0.1.0
          └── depends on: cart
```

---

## Workspace Layout

```
my-workspace/
  pascal.toml              # workspace manifest (pascal reads this)
  pyproject.toml           # UV workspace root (auto-generated by pascal)
  uv.lock                  # lockfile (committed to git)
  packages/
    cart/                  # reusable library
      pyproject.toml
      src/cart/__init__.py
      tests/test_cart.py
    auth/
      pyproject.toml
      src/auth/__init__.py
      tests/test_auth.py
  apps/
    api_service/           # deployable entry-point
      pyproject.toml       # declares: dependencies = ["cart", "auth"]
      src/api_service/__init__.py
      src/api_service/main.py
      tests/test_api_service.py
```

### `pascal.toml` schema

```toml
[workspace]
name = "my-workspace"
python = "3.12"
description = "My Python monorepo"   # optional

# Explicit lists are optional — pascal auto-discovers from packages/ and apps/
packages = ["packages/cart", "packages/auth"]
apps     = ["apps/api_service"]
```

Pascal auto-generates the UV workspace root `pyproject.toml`:

```toml
[tool.uv.workspace]
members = ["packages/*", "apps/*"]
```

Local packages are referenced as UV path dependencies:

```toml
# apps/api_service/pyproject.toml
[tool.uv.sources]
cart = { workspace = true }
auth = { workspace = true }
```

---

## Command Reference

| Command | Description |
|---|---|
| `pascal init [name]` | Bootstrap a new workspace with `pascal.toml`, root `pyproject.toml`, and `uv.lock` |
| `pascal create package <name>` | Scaffold a new reusable library under `packages/` |
| `pascal create app <name>` | Scaffold a new deployable app under `apps/` |
| `pascal add <pkg> --to <app>` | Add a workspace package as a dependency in an app's `pyproject.toml` |
| `pascal info` | Pretty-print workspace overview: packages, apps, dependency wiring |
| `pascal deps [--graph]` | Print the dependency tree; `--graph` emits Graphviz DOT format |
| `pascal check` | Validate the workspace: missing deps, undeclared packages, circular references |
| `pascal diff [--since <ref>]` | Show packages/apps changed since a git ref or tag (defaults to latest tag) |
| `pascal test [--changed] [name]` | Run pytest for one or all packages/apps via UV; `--changed` runs only affected bricks |
| `pascal build <app>` | Run `uv build` for an app (produces a wheel/sdist) |
| `pascal run <app> [-- args]` | Run an app's entry-point via `uv run` |
| `pascal sync` | Regenerate root `pyproject.toml` and UV workspace config from `pascal.toml` |

---

## UV Integration

Pascal is designed to sit alongside UV, not replace it. Pascal handles monorepo structure; UV handles packages, lockfiles, and virtual environments.

```
pascal init        →  creates UV workspace skeleton
pascal create      →  adds a new UV workspace member
pascal add         →  edits pyproject.toml, then calls `uv sync`
pascal sync        →  regenerates the UV workspace config
pascal test        →  delegates to `uv run pytest`
pascal build       →  delegates to `uv build`
pascal run         →  delegates to `uv run`
```

You can always drop into raw UV commands at any time — pascal writes standard UV workspace files that any UV-aware tooling can read.

---

## CI/CD in Your Workspace

Pascal's `--changed` and `--since` flags make it easy to run targeted CI in your monorepo. Here's a GitHub Actions snippet:

```yaml
# .github/workflows/test.yml  (inside your USER workspace, not the pascal source repo)
name: Test changed packages

on:
  pull_request:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0        # needed so pascal can read git history

      - uses: astral-sh/setup-uv@v4

      - name: Install pascal
        run: uv tool install pascal-cli

      - name: Run tests for changed packages
        run: pascal test --changed --since origin/main
```

For a full run (e.g., on merge to main):

```yaml
      - name: Run all tests
        run: pascal test
```

---

## Contributing

```bash
git clone https://github.com/sandeep-selvaraj/pascal
cd pascal
cargo build
cargo test
```

Lint and format:

```bash
cargo fmt
cargo clippy -- -D warnings
```

To test the PyPI packaging locally:

```bash
pip install maturin
maturin build
pip install target/wheels/*.whl
pascal --version
```

Please open an issue before sending a large PR so we can discuss the approach.
